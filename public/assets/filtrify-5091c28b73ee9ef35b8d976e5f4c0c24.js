/**
 * jQuery Filtrify v0.2
 * Beautiful advanced tag filtering with HTML5 and jQuery
 * http://luis-almeida.github.com/filtrify
 *
 * Licensed under the MIT license.
 * Copyright 2012 Lu√≠s Almeida
 * https://github.com/luis-almeida
 */
!function(t,e,i,n){function s(e,i,n){this.options=t.extend({},o,n),this._container=t("#"+e),this._holder=t("#"+i),this._items=this._container.children(),this._matrix=[],this._fields={},this._order=[],this._menu={},this._query={},this._match=[],this._mismatch=[],this._z=9999,this._bind=function(t,e){return function(){return t.apply(e,arguments)}},this.init()}var o={noresults:"No results match",hide:!0,block:[],close:!1,query:n,callback:n};s.prototype.init=function(){this.load(),this.set(),this.options.query!==n&&this.trigger(this.options.query)},s.prototype.load=function(){var e,i,s,o,a,r,l;this._items.each(this._bind(function(h,u){for(e=u.attributes,r={},i=0;i<e.length;i++)if(s=e[i].name,0===s.indexOf("data-")&&-1===t.inArray(s,this.options.block))for(o=s.replace(/data-/gi,"").replace(/-/gi," "),a=u.getAttribute(s).split(", "),r[o]=a,this._fields[o]===n&&(this._order.push(o),this._fields[o]={}),l=0;l<a.length;l++)a[l].length&&(a[l]=a[l].replace(/\\/g,""),this._fields[o][a[l]]=this._fields[o][a[l]]===n?1:this._fields[o][a[l]]+1);this._matrix.push(r)},this))},s.prototype.set=function(){var e,i=0,n=t.browser;for(this._menu.list=t("<ul class='ft-menu' />"),i;i<this._order.length;i++)e=n.webkit||n.opera?this._order[i]:this._order[this._order.length-i-1],this._menu[e]={},this.build(e),this.cache(e),this.events(e),this.append(e),this.query(e);this._holder.html(this._menu.list)},s.prototype.build=function(e){var i,n,s,o=[];i="<li class='ft-field'><span class='ft-label'>"+e+"</span><div class='ft-panel ft-hidden'><ul class='ft-selected' style='display:none;'></ul><fieldset class='ft-search'><input type='text' placeholder='Search' /></fieldset><ul class='ft-tags'>";for(s in this._fields[e])o.push(s);for(o.sort(),n=0;n<o.length;n++)s=o[n],i+="<li data-count='"+this._fields[e][s]+"' >"+s+"</li>";i+="</ul><div class='ft-mismatch ft-hidden'></div></div></li>",this._menu[e].item=t(i)},s.prototype.cache=function(e){this._menu[e].label=this._menu[e].item.find("span.ft-label"),this._menu[e].panel=this._menu[e].item.find("div.ft-panel"),this._menu[e].selected=this._menu[e].item.find("ul.ft-selected"),this._menu[e].search=this._menu[e].item.find("fieldset.ft-search"),this._menu[e].tags=this._menu[e].item.find("ul.ft-tags"),this._menu[e].mismatch=this._menu[e].item.find("div.ft-mismatch"),this._menu[e].highlight=t([]),this._menu[e].active=t([])},s.prototype.append=function(t){this._menu.list.append(this._menu[t].item)},s.prototype.query=function(t){this._query[t]=[]},s.prototype.events=function(e){t(i).on("click",this._bind(function(){this.closePanel(e)},this)),this._menu[e].panel.on("click",this._bind(function(t){t.stopPropagation()},this)),this._menu[e].panel.on("mouseenter",this._bind(function(){this.bringToFront(e)},this)),this._menu[e].label.on("click",this._bind(function(t){this.openPanel(e),this.bringToFront(e),t.stopPropagation()},this)),this._menu[e].search.on("keyup","input",this._bind(function(t){return 38===t.which||40===t.which?!1:(13===t.which?this._menu[e].highlight.length&&(this.select(e),this.filter()):this.search(e,t.target.value),void 0)},this)),this._menu[e].search.on("keydown","input",this._bind(function(t){40===t.which?(this.moveHighlight(e,"down"),t.preventDefault()):38===t.which&&(this.moveHighlight(e,"up"),t.preventDefault())},this)),this._menu[e].tags.on("mouseenter","li",this._bind(function(i){this.highlight(e,t(i.target))},this)),this._menu[e].tags.on("mouseleave","li",this._bind(function(){this.clearHighlight(e)},this)),this._menu[e].tags.on("click","li",this._bind(function(){this.select(e),this.filter()},this)),this._menu[e].selected.on("click","li",this._bind(function(i){this.unselect(e,t(i.target).text()),this.filter()},this))},s.prototype.bringToFront=function(t){this._z=this._z+1,this._menu[t].panel.css("z-index",this._z),this._menu[t].search.find("input").focus()},s.prototype.openPanel=function(t){this._menu[t].label.toggleClass("ft-opened"),this._menu[t].panel.toggleClass("ft-hidden"),this._menu[t].search.find("input").focus()},s.prototype.closePanel=function(t){this.resetSearch(t),this._menu[t].panel.addClass("ft-hidden"),this._menu[t].label.removeClass("ft-opened")},s.prototype.preventOverflow=function(t){var e,i,n,s,o;return n=parseInt(this._menu[t].tags.css("maxHeight"),10),o=this._menu[t].tags.scrollTop(),s=n+o,i=this._menu[t].highlight.position().top+this._menu[t].tags.scrollTop(),e=i+this._menu[t].highlight.outerHeight(),e>=s?this._menu[t].tags.scrollTop(e-n>0?e-n:0):o>i?this._menu[t].tags.scrollTop(i):void 0},s.prototype.moveHighlight=function(t,e){if(this._menu[t].highlight.length){var i="down"===e?"nextAll":"prevAll",n=this._menu[t].highlight[i](":visible:first");n.length&&(this.clearHighlight(t),this.highlight(t,n),this.preventOverflow(t))}else this.highlight(t,this._menu[t].tags.children(":visible:first")),this.preventOverflow(t)},s.prototype.highlight=function(t,e){this._menu[t].highlight=e,this._menu[t].highlight.addClass("ft-highlight")},s.prototype.removeHighlight=function(t){this._menu[t].highlight.removeClass("ft-highlight")},s.prototype.hideHighlight=function(t){this._menu[t].highlight.addClass("ft-hidden")},s.prototype.resetHighlight=function(e){this._menu[e].highlight=t([])},s.prototype.clearHighlight=function(t){this.removeHighlight(t),this.resetHighlight(t)},s.prototype.showMismatch=function(t,e){this._menu[t].mismatch.html(this.options.noresults+' "<b>'+e+'</b>"').removeClass("ft-hidden")},s.prototype.hideMismatch=function(t){this._menu[t].mismatch.addClass("ft-hidden")},s.prototype.search=function(t,e){this.clearHighlight(t),this.showResults(t,e),this.highlight(t,this._menu[t].tags.children(":visible:first"))},s.prototype.resetSearch=function(t){this._menu[t].search.find("input").val(""),this._menu[t].tags.children().not(this._menu[t].active).removeClass("ft-hidden"),this.hideMismatch(t)},s.prototype.showResults=function(e,i){var n=0;this.hideMismatch(e),this._menu[e].tags.children().not(this._menu[e].active).each(function(){(this.textContent||this.innerText).toUpperCase().indexOf(i.toUpperCase())>=0?(t(this).removeClass("ft-hidden"),n+=1):t(this).addClass("ft-hidden")}),n||this.showMismatch(e,i)},s.prototype.select=function(t){this.updateQueryTags(t,this._menu[t].highlight.text()),this.updateActiveClass(t),this.removeHighlight(t),this.appendToSelected(t),this.addToActive(t),this.hideHighlight(t),this.resetHighlight(t),this.resetSearch(t),this.options.close&&this.closePanel(t)},s.prototype.updateQueryTags=function(e,i){var n=t.inArray(i,this._query[e]);-1===n?this._query[e].push(i):this._query[e].splice(n,1)},s.prototype.updateActiveClass=function(t){this._query[t].length?this._menu[t].label.addClass("ft-active"):this._menu[t].label.removeClass("ft-active")},s.prototype.appendToSelected=function(t){this._menu[t].selected.append(this._menu[t].highlight.clone()),this.slideSelected(t)},s.prototype.addToActive=function(t){this._menu[t].active=this._menu[t].active.add(this._menu[t].highlight)},s.prototype.unselect=function(t,e){this.updateQueryTags(t,e),this.removeFromSelected(t,e),this.removeFromActive(t,e),this.updateActiveClass(t),this.resetSearch(t)},s.prototype.removeFromSelected=function(t,e){this._menu[t].selected.children().filter(function(){return(this.textContent||this.innerText)===e}).remove(),this.slideSelected(t)},s.prototype.removeFromActive=function(t,e){this._menu[t].active=this._menu[t].active.filter(function(){return(this.textContent||this.innerText)!==e})},s.prototype.slideSelected=function(t){this._menu[t].selected.children().length?this._menu[t].selected.slideDown("fast"):this._menu[t].selected.slideUp("fast")},s.prototype.filter=function(){var e,i,n,s,o;for(this.resetCachedMatch(),i=this._matrix.length-1;i>=0;i--){o=!0;for(e in this._query){for(s=0,n=this._query[e].length-1;n>=0;n--)-1!==t.inArray(this._query[e][n],this._matrix[i][e])&&(s+=1);!this._query[e].length||s>=this._query[e].length||(o=!1)}this.updateFields(i,o),this.cacheMatch(i,o),this.showMatch(i,o)}this.rewriteFields(),this.callback()},s.prototype.updateFields=function(t,e){var i,s,o;for(i in this._fields)if(t===this._matrix.length-1&&(this._fields[i]={}),s=this._matrix[t][i],e&&s)for(o=0;o<s.length;o++)s[o].length&&(this._fields[i][s[o]]=this._fields[i][s[o]]===n?1:this._fields[i][s[o]]+1)},s.prototype.rewriteFields=function(){var t;for(t in this._fields)this._menu[t].tags.children().each(this._bind(function(e,i){var s=i.textContent||i.innerText,o=this._fields[t][s]===n?0:this._fields[t][s];i.setAttribute("data-count",o)},this))},s.prototype.resetCachedMatch=function(){this._match=[],this._mismatch=[]},s.prototype.cacheMatch=function(t,e){e?this._match.unshift(this._items[t]):this._mismatch.unshift(this._items[t])},s.prototype.showMatch=function(t,e){if(this.options.hide){var i=-1!==this._items[t].className.indexOf("ft-hidden");e?i&&(this._items[t].className=this._items[t].className.replace(/ft-hidden/g,"")):i||(this._items[t].className=this._items[t].className+" ft-hidden")}},s.prototype.callback=function(){this.options.callback!==n&&t.isFunction(this.options.callback)&&this.options.callback(this._query,this._match,this._mismatch)},s.prototype.trigger=function(t){var e;for(e in this._fields)this.clearSearch(e),this.updateQueryField(e,t),this.updateActiveClass(e),this.updatePanel(e),this.toggleSelected(e);this.filter()},s.prototype.clearSearch=function(t){this.clearHighlight(t),this.resetSearch(t),this.clearSelected(t)},s.prototype.clearSelected=function(e){this._menu[e].selected.empty(),this._menu[e].active=t([])},s.prototype.updateQueryField=function(t,e){this._query[t]=e[t]!==n?e[t]:[]},s.prototype.updatePanel=function(t){var e,i=0,n=this._menu[t].tags.children().removeClass("ft-hidden");for(i;i<this._query[t].length;i++)e=n.filter(this._bind(function(e){return(n[e].textContent||n[e].innerText)===this._query[t][i]},this)),this._menu[t].selected.append(e.clone()),this._menu[t].active=this._menu[t].active.add(e),e.addClass("ft-hidden")},s.prototype.toggleSelected=function(t){this._menu[t].selected.children().length?this._menu[t].selected.show():this._menu[t].selected.hide()},s.prototype.reset=function(){this.trigger({})},t.filtrify=function(t,e,i){return new s(t,e,i)}}(jQuery,window,document);